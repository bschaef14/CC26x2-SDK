

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>BIM for On-Chip OAD (Stack Library) &mdash; 
SimpleLink™ CC13x2 / CC26x2 SDK
BLE5-Stack User&#39;s Guide
 2.01.04.00 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OAD Image Header" href="image-header.html" />
    <link rel="prev" title="BIM for Off-Chip OAD" href="bim-off-chip.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug oad-secure bim-on-chip-stack-library";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav">
   <!---- extra body elements for TI beyond RTD Sphinx Theme --->
<div class="DocSite-globalNav tiNav">
    <ul>
    </ul>
</div>

<a class="DocSite-nav" href="https://www.ti.com" style="padding-bottom: 85px;">
  <img class="DocSiteNav-logo"
    src="../_static/img/ti_logo.png"
    alt="TI Logo">
  <div class="DocSiteNav-title"></div>
</a> 
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../ble-stack-5.x-guide/index-cc13x2_26x2.html" class="icon icon-home" alt="Documentation Home"> 
SimpleLink™ CC13x2 / CC26x2 SDK
BLE5-Stack User's Guide

          

          
          </a>

          
            
            
              <div class="version">
                2.01.04.00
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13x2_26x2.html">Introduction to the SimpleLink CC13x2 / 26x2 SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/ble5-quick-start.html">TI BLE5-Stack Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/platform-cc13x2_26x2.html">The CC13x2 or CC26x2 SDK Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/tirtos-index.html">TI-RTOS (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble-stack-5-index-cc13x2_26x2.html">Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble-stack-5-index-cc13x2_26x2.html#ble5-stack">BLE5-Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble-stack-5-index-cc13x2_26x2.html#developing-a-custom-application">Developing a Custom Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/ble-stack-5-index-cc13x2_26x2.html#running-the-sdk-on-custom-hardware">Running the SDK on Custom Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coexistence/coexistence.html">Coexistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/localization-index-cc13x2_26x2.html">RTLS Toolbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/u-stack-index-cc13x2_26x2.html">Micro BLE Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sensor-controller/sensor-controller.html">Sensor Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-common/npi-index.html">Network Processor Interface (NPI)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../ble-stack-5.x-guide/ble5-oad-index-cc13x2_26x2.html">Over-the-Air Download (OAD)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="oad-types.html">OAD Storage &amp; Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="bim.html">Boot Image Manager (BIM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="bim-off-chip.html">BIM for Off-Chip OAD</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">BIM for On-Chip OAD (Stack Library)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#application-execution-switching-using-validation-bytes-in-flash">Application Execution switching using Validation Bytes in Flash</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="image-header.html">OAD Image Header</a></li>
<li class="toctree-l2"><a class="reference internal" href="ext-flash-image-header.html">OAD External Flash Image Header</a></li>
<li class="toctree-l2"><a class="reference internal" href="flash-layout-off-chip.html">Flash Layout for Off-Chip OAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="flash-layout-on-chip-stack-library.html">Flash Layout for On-Chip OAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools.html">OAD Image Tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-oad/oad-application.html">OAD Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-oad/oad-profile.html">BLE-Stack OAD Profile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-oad/setting-up-environment.html">Setting up the BLE OAD Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-oad/performing-an-oad.html">Performing a BLE OAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-oad/creating-a-production-image.html">Creating a Production Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-oad/revert-to-factory.html">Reverting to a Factory Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble-stack-oad/add-ble-oad-to-proj.html">Adding BLE OAD to an Existing Project</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/sysconfig-index-cc13x2_26x2.html">System Configuration Tool (SysConfig)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/migration-cc13x2_26x2.html">Porting Guide and Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/api-reference-cc13x2_26x2.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/reference-cc13x2_26x2.html">Terms and Definitions</a></li>
</ul>

            
          
          <!-- extra nav elements for TI beyond RTD Sphinx Theme --->
<div id="sideBanner">
    <br/>
    <br/><br/><br/>
</div>
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../ble-stack-5.x-guide/index-cc13x2_26x2.html">
SimpleLink™ CC13x2 / CC26x2 SDK
BLE5-Stack User's Guide
</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../ble-stack-5.x-guide/index-cc13x2_26x2.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../ble-stack-5.x-guide/ble5-oad-index-cc13x2_26x2.html">Over-the-Air Download (OAD)</a> &raquo;</li>
        
      <li>BIM for On-Chip OAD (Stack Library)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="bim-for-on-chip-oad-stack-library">
<span id="sec-oad-bim-on-chip-stack-library"></span><h1>BIM for On-Chip OAD (Stack Library)<a class="headerlink" href="#bim-for-on-chip-oad-stack-library" title="Permalink to this headline">¶</a></h1>
<p>This section describes the behavior of the BIM for on-chip OAD where the
combined image approach is used. This approach requires two full application and
stack library pairs on the target device. As with off-chip OAD, it is BIM’s
responsibility to locate which image should be run. In an on-chip OAD system
there are only two image types that can be executed safely:</p>
<blockquote>
<div><ul class="simple">
<li>Persistent application (0x00): Permanently resident application that
implements OAD profile</li>
<li>User application (0x01): OAD upgradeable application that implements OAD
reset service and user functionality</li>
</ul>
</div></blockquote>
<p>For more information about OAD image types, refer to the
<a class="reference internal" href="image-header.html#sec-oad-image-header"><span class="std std-ref">OAD Image Header</span></a> section of this chapter. The roles and
responsibilities of each application in an on-chip system is defined in the
<a class="reference internal" href="../ble-stack-oad/oad-application.html#oad-process"><span class="std std-ref">OAD Application</span></a> section.</p>
<p>In summary, the applications are responsible for storing a candidate image in
internal flash, performing all OAD procedures and protocols, updating the Image
Validation flash field in the OAD image header, and resetting the device when
appropriate. The Image Validation field is a shared RAM variable that allows the
application to indicate which image should be selected by the BIM before
resetting. This is described in <a class="reference internal" href="#sect-ram-argument-stack-library"><span class="std std-ref">Application Execution switching using Validation Bytes in Flash</span></a>.</p>
<p>Based on the Image Validation field in the image header, the BIM will decide
which image is most fit to run. The following will
describe the process by which the BIM selects an image.</p>
<div class="figure align-center" id="id2">
<span id="fig-bim-onchip-stack-library-flowchart"></span><p class="plantuml">
<img src="../_images/plantuml-c83874f5a37781092d4713d95583bec9bba1d5f6.png" alt="&#64;startuml
(*)  --&gt; &quot;Device Boot&quot;
If &quot;Nr of '0' bits in image validation field odd?&quot; then
    --&gt; [Yes] &quot;Set image type, flash page variable based on OAD Image Header&quot;
    --&gt; &quot;Read OAD Image ID field from current flash page&quot;
    If &quot;Image ID found?&quot; then
        --&gt; [Yes] &quot;Read remaining image header&quot;
        If &quot;Image header compatible/valid?&quot; then
            --&gt; [Yes] &quot;Perform additional image validation/copy&quot;
            If &quot;Image is ready to run&quot; then
                --&gt; [Yes] &quot;Jump to Image&quot;
                --&gt;(*)
            else
                --&gt; [No] &quot;Change image type, reset flash page&quot;
            Endif
        else
            --&gt; [No] &quot;Increase flash page number&quot;
        Endif
    else
        --&gt; [No] If &quot;Reached the end of flash?&quot; then
            If &quot;Max number of search iterations?&quot;
                --&gt; [Yes] &quot;Low power mode&quot;
                --&gt; &quot;Low power mode&quot;
            else
                --&gt; [No] &quot;Change image type, reset flash page&quot;
                --&gt; &quot;Read OAD Image ID field from current flash page&quot;
            Endif
        else
            --&gt; [No] &quot;Increase flash page number&quot;
            --&gt; &quot;Read OAD Image ID field from current flash page&quot;
        Endif
    Endif

else
    --&gt; [No] &quot;Set image type to user application, flash page to 0&quot;
    --&gt; &quot;Read OAD Image ID field from current flash page&quot;
Endif
&#64;enduml

Functional Overview of On-chip BIM (stack library)"/>
</p>
<p class="caption"><span class="caption-number">Figure 182. </span><span class="caption-text">Sequence diagram for on-chip BIM image selection process</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>The image above is described in words below. In order to determine which image
is best to run, BIM takes the following measures:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">At startup, the BIM checks the Image Validation field in the
<a class="reference internal" href="image-header.html#sec-oad-image-header"><span class="std std-ref">OAD Image Header</span></a>  and sets active flash page or image type
based on <a class="reference internal" href="#sect-ram-argument-stack-library"><span class="std std-ref">Application Execution switching using Validation Bytes in Flash</span></a>. If the Image Validation
field is unset it will defaultto flash page of 0 and image type of user
application.</p>
</li>
<li><p class="first">BIM checks <code class="docutils literal notranslate"><span class="pre">BIM_ONCHIP_MAX_NUM_SEARCHES</span></code> to make sure the max search
iterations have not been exceeded.</p>
</li>
<li><p class="first">BIM will now go through every flash page in the internal flash in search
for a valid Image Identification value. This is done in the following way:</p>
<blockquote>
<div><ul class="simple">
<li>Read the first 8 bytes and compare to any valid image Identification
value</li>
<li>If a valid image header is found, BIM will read the entire image
header</li>
<li>If a header is not found, increment the flash page and search again
(jump to step #2)</li>
</ul>
</div></blockquote>
<p>This process is repeated until a valid image is found, or the max number
of search iterations is reached.</p>
</li>
<li><p class="first">Checks that the header and BIM version are compatible with the current
BIM.</p>
<blockquote>
<div><ul class="simple">
<li><dl class="first docutils">
<dt>If this check fails, increase the flash page number and search again</dt>
<dd>(jump to step #2). If user application, change image type so that the BIM boots
into to persistent application before searching again</dd>
</dl>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">If a CRC has not been calculated on the image, calculate one and update
CRC status field.</p>
<blockquote>
<div><ul class="simple">
<li>If pending copy (stack image), do not update the CRC field yet, this
will be done after copy</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Check for security. (if not persistent application)</p>
<blockquote>
<div><ul class="simple">
<li>Ensure image is from a trusted peer by running ECDSA sign/verify
algorithm on the image.</li>
<li>If security check fails, increment the flash page and search again
(jump to step #2)</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Check for a valid CRC and image copy status in image header (0xFE).</p>
<blockquote>
<div><ul class="simple">
<li>Copy new user image, calculate CRC to ensure copy succeeded. Update
copy status and CRC status fields accordingly.</li>
<li>If succeeded, set image type to persistent application and set flash
page number to 0.</li>
<li>If failed, continue searching.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Continue this process until an image is found or the max iterations (16
unsuccessful download attempts) is    performed.</p>
<blockquote>
<div><ul class="simple">
<li>If a valid image is found, jump to it</li>
<li>If no valid image is found and the max iterations have been performed,
go to low power mode.</li>
</ul>
</div></blockquote>
</li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The execution flow described by the text and diagrams above is assuming
security is on. If using an unsecured BIM configuration, the process is the
same with the exception that there is no check for security.</p>
</div>
<div class="section" id="application-execution-switching-using-validation-bytes-in-flash">
<span id="sect-ram-argument-stack-library"></span><h2>Application Execution switching using Validation Bytes in Flash<a class="headerlink" href="#application-execution-switching-using-validation-bytes-in-flash" title="Permalink to this headline">¶</a></h2>
<p>In this scheme, BIM passes the execution based on the number of ‘0’ bits in the
Image Validation field. If the number of ‘0’s bits are odd, it will execute
persistent application and if the count is even it executes the user application.</p>
<p>By default, the Image Validation field in the image header will be set
0xFFFFFFFF. On power up, BIM will pass execution to the user application. When
user application wants to upload a new image, it has to switch the execution to
the persistent application. To do this, the application flips the first available
non-zero bit to ‘0’, starting from LSB in the ‘Image Validation’ field. Doing so
will make the number of ‘0’ bits an odd number. The application should then
perform a reset command.</p>
<p>After reset, the BIM will resume execution and check whether the count of ‘0’
bit is odd or even. Once it finds the odd count in the Image Validation field,
the BIM will run the persistent application image (which is initiated by the user
application). The persistent application will start downloading and the new user
image will be authenticated. If new image downloaded and stored successfully,
the ‘Image Validation’ field will be overwritten again to 0xFFFFFFFF and BIM
will be able to execute the newly downloaded image.</p>
<p>If the authentication or the ‘Image Identify’ command (see <a class="reference internal" href="../ble-stack-oad/oad-profile.html#sect-oad-profile"><span class="std std-ref">BLE-Stack OAD Profile</span></a>
for details) fails, user application that is already in flash should be re-
validated. In the persistent app, this is handled by flipping the first
available non-zero bit in the Image Validation field of the existing User
Application OAD Image Header to ‘0’. This makes the number of nonzero bits even.
The board then resets itself again. On startup, the BIM will check again whether
the count of ‘0’ bit is odd or even. This time it will find that the number of
nonzero bits is even, and the BIM executes the user application. This saves the
user application from an unauthorized OAD attempt. The four bytes will allow the
BIM to retry the execution switching process 16 times  between user and
persistent image without turning all bits to ‘0’s(16 unsuccessful downloads).
When all the bits are set to ‘0’s, BIM will always jump to persistent image
forcing the user to upgrade the user application.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="image-header.html" class="btn btn-neutral float-right" title="OAD Image Header" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="bim-off-chip.html" class="btn btn-neutral float-left" title="BIM for Off-Chip OAD" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        <a href="https://www.ti.com/corp/docs/legal/copyright.shtml">2010-2020, Texas Instruments</a>, Texas Instruments Incorporated. All rights reserved. <br>
        <a href="https://www.ti.com/corp/docs/legal/trademark/trademrk.htm">Trademarks</a> | <a href="https://www.ti.com/corp/docs/legal/privacy.shtml">Privacy policy</a> | <a href="https://www.ti.com/corp/docs/legal/termsofuse.shtml">Terms of use</a> | <a href="https://www.ti.com/lsds/ti/legal/termsofsale.page">Terms of sale</a>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>