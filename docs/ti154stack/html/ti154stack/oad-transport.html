

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TI 15.4-Stack OAD &mdash; 
SimpleLink™ CC13x2 / CC26x2 SDK
TI 15.4-Stack User&#39;s Guide
 3.30.00.00 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OAD Image Tool" href="../oad-secure/tools.html" />
    <link rel="prev" title="Flash Layout for On-Chip OAD" href="../oad-secure/flash-layout-on-chip-stack-library.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug ti154stack oad-transport";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav">
   <!---- extra body elements for TI beyond RTD Sphinx Theme --->
<div class="DocSite-globalNav tiNav">
    <ul>
    </ul>
</div>

<a class="DocSite-nav" href="https://www.ti.com" style="padding-bottom: 85px;">
  <img class="DocSiteNav-logo"
    src="../_static/img/ti_logo.png"
    alt="TI Logo">
  <div class="DocSiteNav-title"></div>
</a> 
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../ti154stack-guide/index-cc13x2_26x2.html" class="icon icon-home" alt="Documentation Home"> 
SimpleLink™ CC13x2 / CC26x2 SDK
TI 15.4-Stack User's Guide

          

          
          </a>

          
            
            
              <div class="version">
                3.30.00.00
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart-guide/quickstart-intro-cc13x2_26x2.html">Introduction to the SimpleLink CC13x2 / 26x2 SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/index-platform-cc13x2_26x2.html">CC13x2 or CC26x2 Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/tirtos-index.html">TI-RTOS (RTOS Kernel) Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../ti154stack-guide/ti154stack-index-cc13x2_26x2.html">TI 15.4-Stack</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ti154stack-overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="ti154stack-overview.html#architecture-choices">Architecture Choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="ti154stack-overview.html#data-rate-and-phy">Data-Rate and PHY</a></li>
<li class="toctree-l2"><a class="reference internal" href="application-overview.html">Application Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="example-applications.html">Example Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="common-user-interface.html">Common User Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="secure-commissioning.html">Secure Commissioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="beacon-mode.html">Beacon Enabled Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="non-beacon-mode.html">Non-Beacon Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="frequency-hopping-mode.html">Frequency-Hopping Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring-stack.html">Configuring Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet-sniffer.html">SmartRF Protocol Packet Sniffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="creating-custom-applications.html">Creating Custom Applications</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../ti154stack-guide/oad-secure-index.html">Over-the-Air Download (OAD)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/bim.html">Boot Image Manager (BIM)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/bim-off-chip.html">BIM for Off-Chip OAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/bim-on-chip-stack-library.html">BIM for On-Chip OAD (Stack Library)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/image-header.html">OAD Image Header</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/ext-flash-image-header.html">OAD External Flash Image Header</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/flash-layout-off-chip.html">Flash Layout for Off-Chip OAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/flash-layout-on-chip-stack-library.html">Flash Layout for On-Chip OAD</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">TI 15.4-Stack OAD</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#oad-protocol">OAD Protocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-architecture">OAD Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-protocol-module">OAD Protocol Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-storage-module">OAD Storage Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-client-module">OAD Client Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-server">OAD Server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-pause-and-resume">OAD Pause and Resume</a></li>
<li class="toctree-l4"><a class="reference internal" href="#support-for-multiple-oad-files">Support for multiple OAD files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oad-default-settings">OAD Default Settings</a></li>
<li class="toctree-l4"><a class="reference internal" href="#turbo-oad-protocol">Turbo OAD Protocol</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../oad-secure/tools.html">OAD Image Tool</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ti154stack-guide/sysconfig-index.html">System Configuration (SysConfig)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cc13x2_26x2/custom-hardware-cc13x2_26x2.html">Custom Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/migration-guide-cc13x2_26x2.html">Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-reference.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/references-cc13x2_26x2.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ti154stack-guide/references-cc13x2_26x2.html#terms-and-acronyms">Terms and Acronyms</a></li>
</ul>

            
          
          <!-- extra nav elements for TI beyond RTD Sphinx Theme --->
<div id="sideBanner">
    <br/>
    <br/><br/><br/>
</div>
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../ti154stack-guide/index-cc13x2_26x2.html">
SimpleLink™ CC13x2 / CC26x2 SDK
TI 15.4-Stack User's Guide
</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../ti154stack-guide/index-cc13x2_26x2.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../ti154stack-guide/ti154stack-index-cc13x2_26x2.html">TI 15.4-Stack</a> &raquo;</li>
        
          <li><a href="../ti154stack-guide/oad-secure-index.html">Over-the-Air Download (OAD)</a> &raquo;</li>
        
      <li>TI 15.4-Stack OAD</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ti-15-4-stack-oad">
<span id="oad-process"></span><h1>TI 15.4-Stack OAD<a class="headerlink" href="#ti-15-4-stack-oad" title="Permalink to this headline">¶</a></h1>
<p>This section describes the TI 15.4-Stack specific implementation of OAD. First
the OAD protocol is explained, then the various software modules (OAD client,
OAD storage, etc).</p>
<div class="section" id="oad-protocol">
<span id="sec-oad-protocol"></span><h2>OAD Protocol<a class="headerlink" href="#oad-protocol" title="Permalink to this headline">¶</a></h2>
<p>The OAD protocol is based on the principle that the OAD server initiates the
firmware download process, to which the OAD client then requests OAD FW image
blocks. The OAD client is responsible for requesting image blocks, handling
error conditions, and re-requesting image block when required. Once the OAD
has completed the OAD Client will reset and start running the new image.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If the device is connected to an external debugger when performing an OAD,
the device could potentially not reset properly after a successful OAD.
This is a known issue, however, simply unplugging/replugging or hard resetting
the device will make the device boot properly. Read more about this in
detail in Section <a class="reference internal" href="../oad-secure/bim.html#sec-oad-bim-hib"><span class="std std-ref">Halt In Boot (HIB)</span></a>.</p>
</div>
<div class="section" id="oad-messages">
<span id="sect-oad-profile"></span><h3>OAD Messages<a class="headerlink" href="#oad-messages" title="Permalink to this headline">¶</a></h3>
<p>The OAD Protocol uses requests and responses between the OAD server
(Distributer) and OAD client (Target). The supported messages are described in
<a class="reference internal" href="#tab-oad-protocol-messages"><span class="std std-numref">Table 22.</span></a>.</p>
<table border="1" class="docutils" id="tab-oad-protocol-messages">
<caption><span class="caption-number">Table 22. </span><span class="caption-text">OAD Protocol Message Types</span><a class="headerlink" href="#tab-oad-protocol-messages" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="5%" />
<col width="2%" />
<col width="2%" />
<col width="91%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Message</th>
<th class="head">Client</th>
<th class="head">Server</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>FwVersionReq</td>
<td>RX</td>
<td>TX</td>
<td>Request Firmware version of an OAD client node.</td>
</tr>
<tr class="row-odd"><td>FwVersionRsp</td>
<td>TX</td>
<td>RX</td>
<td>Response sent from an OAD client node contatining the firmware version currently running. The OAD server uses this information to determine if an update is necessary.</td>
</tr>
<tr class="row-even"><td>ImgIdentifyReq</td>
<td>RX</td>
<td>TX</td>
<td>Request containing the OAD header of the new FW image sent to a specific OAD client node.</td>
</tr>
<tr class="row-odd"><td>ImgIdentifyRsp</td>
<td>TX</td>
<td>RX</td>
<td>Response from the OAD client node. If the OAD image header is accepted by the OAD client node then the response will contain a success status, if not it will contain a fail status. The reasons for an OAD client node to send a fail status could include: Invalid image type, Invalid version (client is running a newer version), or Invalid binary size.</td>
</tr>
<tr class="row-even"><td>SendOadImgBlockReq</td>
<td>TX</td>
<td>RX</td>
<td>If the OAD client node accepts the image header in the ImgIdentifyReq then it will request OAD blocks using the SendOadImgBlockReq. The OAD client will implement a timeout for the SendOadImgBlockRsp and will re-request the OAD block n times if a timeout occurs.</td>
</tr>
<tr class="row-odd"><td>SendOadImgBlockRsp</td>
<td>RX</td>
<td>TX</td>
<td>The requested OAD block will be sent by the OAD server in a SendOadImgBlockRsp. The SendOadImgBlockReq’s and SendOadImgBlockRsp’s will continue until all blocks have been received by the OAD client. Default OAD_BLOCK_SIZE = 128.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="oad-message-flow">
<h3>OAD Message Flow<a class="headerlink" href="#oad-message-flow" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#fig-oad-protocol-flow"><span class="std std-numref">Figure 85.</span></a> shows the flow of OAD messages throughout the
entire OAD process.</p>
<div class="figure align-center" id="fig-oad-protocol-flow">
<img alt="../_images/fig-oad-protocol-flow.png" src="../_images/fig-oad-protocol-flow.png" />
<p class="caption"><span class="caption-number">Figure 85. </span><span class="caption-text">OAD Protocol Flow Diagram</span></p>
</div>
<p>The following sequence diagrams illustrate the message flow for the various
stages in the OAD. The message flow assumes that the server is a Fully
Functional Device (<a class="reference internal" href="../ti154stack-guide/references-cc13x2_26x2.html#term-ffd"><span class="xref std std-term">FFD</span></a>) and the client is a Reduced Functional Device
(<a class="reference internal" href="../ti154stack-guide/references-cc13x2_26x2.html#term-rfd"><span class="xref std std-term">RFD</span></a>).</p>
<div class="section" id="fw-version">
<h4>FW Version<a class="headerlink" href="#fw-version" title="Permalink to this headline">¶</a></h4>
<p>The FW version is requested by the application on the server and responded to by
the application on the client. The client will only receive the request when it
sends a Data Request to the server.</p>
<div class="figure align-center" id="id9">
<img alt="../_images/fig-oad-fw-version.png" src="../_images/fig-oad-fw-version.png" />
<p class="caption"><span class="caption-number">Figure 86. </span><span class="caption-text">FwVersionReq and FwVersionRsp</span></p>
</div>
</div>
<div class="section" id="initiating-oad">
<h4>Initiating OAD<a class="headerlink" href="#initiating-oad" title="Permalink to this headline">¶</a></h4>
<p>An OAD is initiated by the OAD server and is accepted by the OAD client. The
client will only receive the request when it sends a Data Request to the server.
The OAD Initiate request will only be accepted by the client if the image header
in the request is valid.</p>
<div class="figure align-center" id="id10">
<img alt="../_images/fig-oad-init.png" src="../_images/fig-oad-init.png" />
<p class="caption"><span class="caption-number">Figure 87. </span><span class="caption-text">OAD process being initiated.</span></p>
</div>
</div>
<div class="section" id="oad-block-transfers">
<h4>OAD Block Transfers<a class="headerlink" href="#oad-block-transfers" title="Permalink to this headline">¶</a></h4>
<p>An OAD client sends a Image Block Request to to OAD server. There are three
possible outcomes of this request:</p>
<blockquote>
<div><ul class="simple">
<li>A single block is transfered successfully</li>
<li>A single block is transfered, but requires multiple poll requests</li>
<li>A request time-out occurs and the request is retried</li>
</ul>
</div></blockquote>
<p><a class="reference internal" href="#fig-oad-block-transfer"><span class="std std-numref">Figure 88.</span></a> illustrates a message flow for a single block
transfer, and assumes no timeouts occur. Block n represent block 0 to the 2nd to
last image block.</p>
<div class="figure align-center" id="fig-oad-block-transfer">
<img alt="../_images/fig-oad-block-transfer.png" src="../_images/fig-oad-block-transfer.png" />
<p class="caption"><span class="caption-number">Figure 88. </span><span class="caption-text">Single Block Transfer.</span></p>
</div>
<p><a class="reference internal" href="#fig-oad-block-poll"><span class="std std-numref">Figure 89.</span></a> illustrates a message flow for a single block
transfer, where the OAD server does not retrieve the image block before the
clients Data Request. Block n represent a random block in the image where the
image block is not ready in time for the Data Request.</p>
<div class="figure align-center" id="fig-oad-block-poll">
<img alt="../_images/fig-oad-block-poll.png" src="../_images/fig-oad-block-poll.png" />
<p class="caption"><span class="caption-number">Figure 89. </span><span class="caption-text">Single Block Transer with Multiple Poll Requests.</span></p>
</div>
<p><a class="reference internal" href="#fig-oad-block-transfer-retry"><span class="std std-numref">Figure 90.</span></a> illustrates a message flow for a single
block transfer, where the OAD clients block request is lost, possibly due to a
queue overflow. Block n represent a random block in the image where the image
block request is lost. The below assumes a maximum of 3 Data Request time-outs.</p>
<div class="figure align-center" id="fig-oad-block-transfer-retry">
<img alt="../_images/fig-oad-block-transfer-retry.png" src="../_images/fig-oad-block-transfer-retry.png" />
<p class="caption"><span class="caption-number">Figure 90. </span><span class="caption-text">Single Block Timeout and is Retried.</span></p>
</div>
<p>The downfall here is that the OAD client will continue sending poll requests
for a block response that will not come. This should be considered when choosing
the OAD_BLOCK_REQ_POLL_DELAY. The trade off is that for longer OAD_BLOCK_REQ_POLL_DELAYs the
OAD server will need to queue the block request in the MAC data queue of the
embedded collector for longer. Queuing OAD blocks in the MAC data buffer for
large amounts of time could lead to a queue overflow and further block requests
not being serviced.</p>
</div>
</div>
<div class="section" id="oad-configurable-parameters">
<h3>OAD Configurable Parameters<a class="headerlink" href="#oad-configurable-parameters" title="Permalink to this headline">¶</a></h3>
<p>The following parameters can be configured at compile-time:</p>
<ul class="simple">
<li>OAD_BLOCK_REQ_POLL_DELAY: This define is measured in ms and controls the timing on
the OAD client from the sending the Block Request to sending the poll
request for the OAD Block Response. A smaller OAD_BLOCK_REQ_POLL_DELAY decreases
the amount of time the OAD Block is queued in the collector and hence the
chance that the collector will suffer a buffer overflow. However the
collector will take a finite amount of time to retrieve the OAD block, and
queue the OAD Block Response, so care must be taken to make the
OAD_BLOCK_REQ_POLL_DELAY long enough to allow the collector to retrieve the OAD
block after receiving the OAD Block request. It is advisable to make this as
small as possible in large networks where the collector needs to queue
messages for many RFD’s.</li>
<li>OAD_BLOCK_REQ_RATE: This define is measured in ms. It defines the amount of
time on the OAD client between 1 block request and the next block request.
Reducing this will reduce the time taken to send an OAD. How quickly the OAD
takes to complete is application dependent, severaly power constrained
devices may need large periods between block req to allow the power source
to recover. Other applications may need the OAD to complete quickly, such
as in systems where a service engineer is required to perform the OAD.</li>
<li>OAD_BLOCK_SIZE: This define also affects the time taken to complete the OAD.
The OAD_BLOCK_SIZE is the number of bytes sent in an OAD Block and can be from
16 to 496B. Care must be taking when setting this to a high value in environments
where noise is a concern, as the chances of a block being corrupted due to an
interferer increases with the size of the block.</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Increasing <code class="docutils literal notranslate"><span class="pre">OAD_BLOCK_SIZE</span></code> past 128 on a linux VM may cause
instability.</p>
</div>
</div>
</div>
<div class="section" id="oad-architecture">
<span id="sec-oad-client"></span><h2>OAD Architecture<a class="headerlink" href="#oad-architecture" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="#fig-oad-block-diagram"><span class="std std-numref">Figure 91.</span></a> shows the SW Architecture for the OAD
feature.</p>
<div class="figure align-center" id="fig-oad-block-diagram">
<img alt="../_images/fig-oad-block-diagram.png" src="../_images/fig-oad-block-diagram.png" />
<p class="caption"><span class="caption-number">Figure 91. </span><span class="caption-text">TI 15.4-Stack OAD Block Diagram</span></p>
</div>
<div class="section" id="modules">
<h3>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h3>
<p>TI 15.4-Stack OAD comprises of the following software modules:</p>
<ul class="simple">
<li>OAD Protocol Module</li>
<li>OAD Storage Module</li>
<li>OAD Client Module</li>
</ul>
<p>The OAD server module is simpler than the OAD client, and does not need to
handle events, error conditions, or retries. The OAD server functionality is
embedded into the existing Linux collector module.</p>
</div>
</div>
<div class="section" id="oad-protocol-module">
<h2>OAD Protocol Module<a class="headerlink" href="#oad-protocol-module" title="Permalink to this headline">¶</a></h2>
<p>The OAD protocol interface provides device independent APIs, data types, and
macros. The Over the Air Download (OAD) protocol module provides protocol
functionality for transferring an OAD image. The APIs in this module serve as an
interface to a TI-RTOS application and offers functionality for an OAD messaging
protocol between OAD sever and the OAD client. The module handles the formatting
and parsing of messages.</p>
<div class="section" id="initialization">
<h3>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h3>
<p>In order to use the OAD protocol APIs, the application is required to provide
application specific configuration and callbacks. For the application to process
OAD Messages the following callback table must be provided:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** @brief OADProtocol callback table</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">fwVersionReqCb_t</span>      <span class="n">pfnFwVersionReqCb</span><span class="p">;</span> <span class="c1">///&lt; Incoming FW Req</span>
    <span class="n">fwVersionRspCb_t</span>      <span class="n">pfnFwVersionRspCb</span><span class="p">;</span> <span class="c1">///&lt; Incoming FW Version Rsp</span>
    <span class="n">oadImgIdentifyReqCb_t</span> <span class="n">pfnOadImgIdentifyReqCb</span><span class="p">;</span> <span class="c1">///&lt; Incoming Image Identify Req</span>
    <span class="n">oadImgIdentifyRspCb_t</span> <span class="n">pfnOadImgIdentifyRspCb</span><span class="p">;</span> <span class="c1">///&lt; Incoming Image Identify Rsp</span>
    <span class="n">oadBlockReqCb_t</span>       <span class="n">pfnOadBlockReqCb</span><span class="p">;</span> <span class="c1">///&lt; Incoming OAD Block Req</span>
    <span class="n">oadBlockRspCb_t</span>       <span class="n">pfnOadBlockRspCb</span><span class="p">;</span> <span class="c1">///&lt; Incoming OAD Block Rsp</span>
<span class="p">}</span> <span class="n">OADProtocol_MsgCBs_t</span><span class="p">;</span>
</pre></div>
</div>
<p>For the OAD module to allocate buffers and send messages the following platform
specific callback must be provided:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** @brief OADProtocol radio access functions</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="n">radioAccessAllocMsg_t</span>        <span class="n">pfnRadioAccessAllocMsg</span><span class="p">;</span>   <span class="c1">///&lt; Function for allocating a message buffer</span>
    <span class="n">radioAccessPacketSend_t</span>      <span class="n">pfnRadioAccessPacketSend</span><span class="p">;</span> <span class="c1">///&lt; Function for sending message over the radio</span>
<span class="p">}</span> <span class="n">OADProtocol_RadioAccessFxns_t</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">OADProtocol_init()</span></code> must be called before any other OADProtocol APIs. The
following parametric configuration is passed:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** @brief RF parameter struct</span>
<span class="cm"> *  RF parameters are used with the OADProtocol_open() and OADProtocol_Params_init() call.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">OADProtocol_RadioAccessFxns_t</span>  <span class="o">*</span><span class="n">pRadioAccessFxns</span><span class="p">;</span>    <span class="c1">///&lt; Radio access function table</span>
    <span class="n">OADProtocol_MsgCBs_t</span>           <span class="o">*</span><span class="n">pProtocolMsgCallbacks</span><span class="p">;</span>          <span class="c1">///&lt; Application Callbacks for pressing packets</span>
<span class="p">}</span> <span class="n">OADProtocol_Params_t</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="application-interface">
<h3>Application Interface<a class="headerlink" href="#application-interface" title="Permalink to this headline">¶</a></h3>
<p>The OAD protocol module formats and parses the OAD messages. The following API
are exposed:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** @brief  Function to initialize the OADProtocol_Params struct to its defaults</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  params      An pointer to RF_Params structure for</span>
<span class="cm"> *                      initialization</span>
<span class="cm"> *</span>
<span class="cm"> *  Defaults values are:</span>
<span class="cm"> *     pRadioAccessFxns     = {0}</span>
<span class="cm"> *      pCallbacks          = {0}</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">OADProtocol_Params_init</span><span class="p">(</span><span class="n">OADProtocol_Params_t</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>

<span class="cm">/** @brief  Function that initializes the Wsn Protocol Task and creates all TI-RTOS objects</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">OADProtocol_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/** @brief  Function to open the OADProtocol module</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  params      An pointer to RF_Params structure for initialization</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">OADProtocol_open</span><span class="p">(</span><span class="n">OADProtocol_Params_t</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>

<span class="cm">/** @brief  Function to parse OADProtocol packets</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  srcAddr             address of the device that sent the message</span>
<span class="cm"> *  @param  incomingPacket      pointer to packet to be parsed</span>
<span class="cm"> *  @param  packetLen           length of the message</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">OADProtocol_Status_t</span> <span class="nf">OADProtocol_ParseIncoming</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">pSrcAddr</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">incomingPacket</span><span class="p">);</span>


<span class="cm">/** @brief  Function to send a FW version request packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the request to</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">OADProtocol_Status_t</span> <span class="nf">OADProtocol_sendFwVersionReq</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">pDstAddress</span><span class="p">);</span>

<span class="cm">/** @brief  Function to send a FW version response packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the response to</span>
<span class="cm"> *  @param  fwVersion           Firmware version string to send</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">OADProtocol_Status_t</span> <span class="nf">OADProtocol_sendFwVersionRsp</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">pDstAddress</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fwVersion</span><span class="p">);</span>

<span class="cm">/** @brief  Function to send an OAD image identify request packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the request to</span>
<span class="cm"> *  @param  imgId               image ID used for requesting image blocks</span>
<span class="cm"> *  @param  pImgInfoData        Image header</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">OADProtocol_Status_t</span> <span class="nf">OADProtocol_sendImgIdentifyReq</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">pDstAddress</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">imgId</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pImgInfoData</span><span class="p">);</span>

<span class="cm">/** @brief  Function to send an OAD image identify request packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the response to</span>
<span class="cm"> *  @param  status              status to send</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">OADProtocol_Status_t</span> <span class="nf">OADProtocol_sendOadIdentifyImgRsp</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">pDstAddress</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">status</span><span class="p">);</span>

<span class="cm">/** @brief  Function to send an OAD block request packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the request to</span>
<span class="cm"> *  @param  imgId               image ID of image blocks</span>
<span class="cm"> *  @param  blockNum            block Number to request</span>
<span class="cm"> *  @param  multiBlockSize      Numer of blocks in the multi Block transfer (0 or 1 for none-multiblock)</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">OADProtocol_Status_t</span> <span class="nf">OADProtocol_sendOadImgBlockReq</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">pDstAddress</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">imgId</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">blockNum</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">multiBlockSize</span><span class="p">);</span>

<span class="cm">/** @brief  Function to send an OAD block response packet</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  dstAddress          Address to send the response to</span>
<span class="cm"> *  @param  imgId               image ID of image blocks</span>
<span class="cm"> *  @param  blockNum            Block number</span>
<span class="cm"> *  @param  block               pointer to image block</span>
<span class="cm"> *</span>
<span class="cm"> *  @return                     Status</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">OADProtocol_Status_t</span> <span class="nf">OADProtocol_sendOadImgBlockRsp</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">pDstAddress</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">imgId</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">blockNum</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">block</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h3>
<p>To use the OAD protocol module to format and parse OAD messages, the application
calls the following APIs:</p>
<blockquote>
<div><ul class="simple">
<li>OADProtocol_init(): Initialize the OADProtocol module/task</li>
<li>OADProtocol_Params_init(): Initialize a OADProtocol_Params structure with
default values. Then change the parameters from non-default values as
needed.</li>
<li>OADProtocol_open(): Open an instance of the OADProtocol module, passing the
initialized parameters.</li>
<li>OADProtocol_sendFwRequest(): This is an example of an OAD message that is
formatted and sent.</li>
</ul>
</div></blockquote>
<p>The following code example opens OADProtocol, sends a FW version request and
processes the response.:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">OADProtocol_packetCBs_t</span> <span class="n">OADProtocolCbs</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nb">NULL</span><span class="p">,</span> <span class="c1">//Incoming FW Req</span>
  <span class="n">fwVersionReqCb</span><span class="p">,</span> <span class="c1">//Incoming FW Version Rsp</span>
  <span class="nb">NULL</span><span class="p">,</span> <span class="c1">//Incoming Image Identify Req</span>
  <span class="nb">NULL</span><span class="p">,</span> <span class="c1">//Incoming Image Identify Rsp</span>
  <span class="nb">NULL</span><span class="p">,</span> <span class="c1">//Incoming OAD Block Req</span>
  <span class="nb">NULL</span><span class="p">,</span> <span class="c1">//Incoming OAD Block Rsp</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fwVersionRspCb</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">srcAddr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fwVersionStr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//Do something with srcAddr and fwVersionStr</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">someTaskInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">OADProtocol_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">someTaskFxn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Set Default parameters structure</span>
  <span class="k">static</span> <span class="n">OADProtocol_Params_t</span> <span class="n">OADProtocol_params</span><span class="p">;</span>

  <span class="c1">// Initialize and open the Wsn Protocol Task</span>
  <span class="n">OADProtocol_Params_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OADProtocol_params</span><span class="p">);</span>
  <span class="n">OADProtocol_params</span><span class="p">.</span><span class="n">pCallbacks</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">OADProtocolCbs</span><span class="p">;</span>
  <span class="n">OADProtocol_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OADProtocol_params</span><span class="p">);</span>

  <span class="n">OADProtocol_sendFwVersionReq</span><span class="p">(</span><span class="n">nodeAddress</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="oad-storage-module">
<h2>OAD Storage Module<a class="headerlink" href="#oad-storage-module" title="Permalink to this headline">¶</a></h2>
<p>The OAD storage interface provides device independent APIs, data types, and
macros for storing the OAD image. The OAD storage module calls into oad_target,
which provide the device dependent functionality to write the OAD image into
flash. oad_target contains the support for internal (on-chip) and external
(off-chip) OAD image storage.</p>
<div class="section" id="oad-storage-configuration">
<h3>OAD Storage Configuration<a class="headerlink" href="#oad-storage-configuration" title="Permalink to this headline">¶</a></h3>
<p>The oad_target module can be configured at build time to use on-chip or off-chip
storage by linking or copying in the correct target c file:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">oad_target_external_flash.c</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">oad_target_internal_flash.c</span></code></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For on-chip OAD, the OAD storage module must be built with
<code class="docutils literal notranslate"><span class="pre">FEATURE_OAD_ONCHIP</span></code> defined.</p>
</div>
</div>
<div class="section" id="initilization">
<h3>Initilization<a class="headerlink" href="#initilization" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">OADStorage_init()</span></code> must be called before any other OADTarget APIs.</p>
</div>
<div class="section" id="id6">
<h3>Application Interface<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>The OAD storage module exposes the following API for staring the OAD image:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_init</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Initialise the OAD Target Profile.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   None.</span>
<span class="cm"> *</span>
<span class="cm"> * @return  None.</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">OADStorage_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgIdentifyRead</span>
<span class="cm"> *</span>
<span class="cm">* @brief   Read Image header and return number of blocks.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   imageType   - image type indicating which image to read</span>
<span class="cm"> * @param   pImgHdr     - pointer to image header data</span>
<span class="cm"> *</span>
<span class="cm"> * @return  Total Blocks if image accepted, 0 if Image invalid</span>
<span class="cm"> */</span>
<span class="kt">uint16_t</span> <span class="nf">OADStorage_imgIdentifyRead</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">imageType</span><span class="p">,</span> <span class="n">OADStorage_imgIdentifyPld_t</span><span class="o">*</span> <span class="n">pImgId</span><span class="p">);</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgIdentifyWrite</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Process the Image Identify Write.  Determine from the received OAD</span>
<span class="cm"> *          Image Header if the Downloaded Image should be acquired.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   pValue     - pointer to data to be written</span>
<span class="cm"> *</span>
<span class="cm">  * @return  Total Blocks if image accepted, 0 if Image rejected</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">uint16_t</span> <span class="nf">OADStorage_imgIdentifyWrite</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pValue</span><span class="p">);</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgBlockRead</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Read Image Block.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   blockNum   - block number to be written</span>
<span class="cm"> * @param   pBlockData - pointer for data to be read</span>
<span class="cm"> *</span>
<span class="cm"> * @return  none</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">OADStorage_Status_t</span> <span class="nf">OADStorage_imgBlockRead</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">blockNum</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pBlockData</span><span class="p">);</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgInfoRead</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Read an Image info.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   pimgInfo - pointer for data to be read</span>
<span class="cm"> *</span>
<span class="cm"> * @return  none</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">OADStorage_imgInfoRead</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pimgInfo</span><span class="p">);</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgBlockWrite</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Write Image Block.</span>
<span class="cm"> *</span>
<span class="cm"> * @param   blockNum   - block number to be written</span>
<span class="cm"> * @param   pBlockData - pointer to data to be written</span>
<span class="cm"> * @param   len        - length fo block</span>
<span class="cm"> *</span>
<span class="cm"> * @return  status</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">OADStorage_Status_t</span> <span class="nf">OADStorage_imgBlockWrite</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">blockNum</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pBlockData</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">len</span><span class="p">);</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_eraseImgPage</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Erases an Image page. Note this is only needed if an image</span>
<span class="cm"> *          page has been corrupted typically OADStorage_imgBlockWrite</span>
<span class="cm"> *          pre-erase all pages</span>
<span class="cm"> *</span>
<span class="cm"> * @param  none</span>
<span class="cm"> *</span>
<span class="cm"> * @return  OADStorage_Status_t</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">OADStorage_Status_t</span> <span class="nf">OADStorage_eraseImgPage</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">page</span><span class="p">);</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_imgFinalise</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Process the Image Block Write.</span>
<span class="cm"> *</span>
<span class="cm"> * @param  none</span>
<span class="cm"> *</span>
<span class="cm"> * @return  status</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">OADStorage_Status_t</span> <span class="nf">OADStorage_imgFinalise</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_createFactoryImageBackup</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   This function creates factory image backup of current running image</span>
<span class="cm"> *</span>
<span class="cm"> * @param   None</span>
<span class="cm"> *</span>
<span class="cm"> * @return  status  OADStorage_Status_Success/OADStorage_FlashError</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">uint8_t</span> <span class="nf">OADStorage_createFactoryImageBackup</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_checkFactoryImage</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   This function check if the valid factory image exists on external</span>
<span class="cm"> *          flash</span>
<span class="cm"> *</span>
<span class="cm"> * @param   None</span>
<span class="cm"> *</span>
<span class="cm"> * @return  TRUE If factory image exists on external flash, else FALSE</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">bool</span> <span class="nf">OADStorage_checkFactoryImage</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> * @fn      OADStorage_close</span>
<span class="cm"> *</span>
<span class="cm"> * @brief   Releases the resource required for OAD stoarage.</span>
<span class="cm"> *</span>
<span class="cm"> * @param  none</span>
<span class="cm"> *</span>
<span class="cm"> * @return none</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">OADStorage_close</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="oad-client-module">
<h2>OAD Client Module<a class="headerlink" href="#oad-client-module" title="Permalink to this headline">¶</a></h2>
<p>The OAD client module has been designed to provide a simple and customizable
implementation for the customer. In its most rudimentary form, this
module is responsible for accepting/rejecting an OAD interaction based
on image header criteria, storing the image in its appropriate location,
and causing a device reset if the download is successful so that the
downloaded application image is run by the <a class="reference internal" href="../ti154stack-guide/references-cc13x2_26x2.html#term-bim"><span class="xref std std-term">BIM</span></a>.</p>
<p>The OAD client module provides a service to process and generate application
events for OAD client functionality.  It is specific to a TI 15.4-Stack
application and houses the code required for the application to act as an OAD
target, reducing the code needing to be added in the application files. The OAD
client uses the services provided by the OAD protocol and OAD storage modules.</p>
<div class="section" id="id7">
<h3>Initialization<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>In order for the OAD client module to process and generate application events it
needs to be initialized with an event handle used to set event masks as they
occur and the applications semaphore that can be used to wake up the
application after an event is set.</p>
<p><code class="docutils literal notranslate"><span class="pre">OADClient_init()</span></code> must be called before the module can process OAD events.
The following parametric configuration is passed:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** @brief RF parameter struct</span>
<span class="cm"> *  RF parameters are used with the SOADProtocol_open() and SOADProtocol_Params_init() call.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">pEvent</span><span class="p">;</span>             <span class="c1">///&lt; Event handle to post to</span>
<span class="cp">#ifdef OSAL_PORT2TIRTOS</span>
    <span class="n">Semaphore_Handle</span> <span class="n">eventSem</span><span class="p">;</span>    <span class="c1">///&lt; Semaphore to post event</span>
<span class="cp">#else</span>
    <span class="n">ICall_Semaphore</span> <span class="n">eventSem</span><span class="p">;</span>    <span class="c1">///&lt; Semaphore to post event</span>
<span class="cp">#endif </span><span class="cm">/*OSAL_PORT2TIRTOS */</span><span class="cp"></span>
<span class="p">}</span> <span class="n">OADClient_Params_t</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3>Application Interface<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>The OAD Client module formats and parses the OAD messages. The following
API is exposed:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span> <span class="cm">/** @brief  Function to open the SOADProtocol module</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  params      An pointer to OADClient_Params_t structure for initialization</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">OADClient_open</span><span class="p">(</span><span class="n">OADClient_Params_t</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>

 <span class="cm">/** @brief  Function to process OAD events</span>
<span class="cm"> *</span>
<span class="cm"> *  @param  pEvent      Event to process</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">OADClient_processEvent</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="n">pEvent</span><span class="p">);</span>

<span class="cm">/** @brief  Function abort OAD</span>
<span class="cm">*</span>
<span class="cm">*  @param  resume      set to true if a auto resume is required</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">OADClient_abort</span><span class="p">(</span><span class="kt">bool</span> <span class="n">resume</span><span class="p">);</span>

<span class="cm">/** @brief  Function abort OAD</span>
<span class="cm">*</span>
<span class="cm">*  @param  delay      time in ms to start resume</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">OADClient_resume</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">delay</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="example-function-trace">
<h3>Example Function Trace<a class="headerlink" href="#example-function-trace" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#fig-oad-req-message-flow"><span class="std std-numref">Figure 92.</span></a> shows the typical function flow for an OAD
client to send a message from the application through the OAD client and
OAD protocol modules to the MAC API.</p>
<div class="figure align-center" id="fig-oad-req-message-flow">
<img alt="../_images/fig-oad-req-message-flow.png" src="../_images/fig-oad-req-message-flow.png" />
<p class="caption"><span class="caption-number">Figure 92. </span><span class="caption-text">Block Request message flow.</span></p>
</div>
<p><a class="reference internal" href="#fig-oad-rsp-message-flow"><span class="std std-numref">Figure 93.</span></a> shows the typical function flow for an OAD
client receiving a messge from the OAD server through the OAD protocol module to
the MAC API.</p>
<div class="figure align-center" id="fig-oad-rsp-message-flow">
<img alt="../_images/fig-oad-rsp-message-flow.png" src="../_images/fig-oad-rsp-message-flow.png" />
<p class="caption"><span class="caption-number">Figure 93. </span><span class="caption-text">Block Response processing.</span></p>
</div>
</div>
</div>
<div class="section" id="oad-server">
<span id="sec-oad-server"></span><h2>OAD Server<a class="headerlink" href="#oad-server" title="Permalink to this headline">¶</a></h2>
<p>There is no separate tool for the OAD server, OAD server functionality is
provided by the Linux collector application as part of the <a class="reference external" href="http://www.ti.com/tool/ti-15.4-stack-gateway-linux-sdk">TI 15.4-Stack Linux
SDK</a>. When the collector application is built without the <code class="docutils literal notranslate"><span class="pre">IS_HEADLESS</span></code> flag
an interactive command-line interface to the collector application exposes the
following functionality:</p>
<blockquote>
<div><ul class="simple">
<li>Devices can be selected</li>
<li>A firmware file can be selected for transfer</li>
<li>LED toggle requests can be sent to the selected device</li>
<li>Version requests can be sent to the selected device</li>
<li>Firmware update requests can be sent to the selected device</li>
</ul>
</div></blockquote>
<p>A typical view of this interface</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TI</span> <span class="n">Collector</span>
<span class="nl">Nwk</span><span class="p">:</span> <span class="n">Started</span>
<span class="n">Sensor</span> <span class="mh">0x0001</span><span class="o">:</span> <span class="n">Temp</span> <span class="mi">25</span><span class="p">,</span> <span class="n">RSSI</span> <span class="o">-</span><span class="mi">18</span>
<span class="n">Sensor</span> <span class="mh">0x0002</span><span class="o">:</span> <span class="n">OAD</span> <span class="n">Block</span> <span class="mi">211</span> <span class="n">of</span> <span class="mi">960</span>


<span class="nl">Info</span><span class="p">:</span> <span class="n">Sending</span> <span class="mh">0x0002</span> <span class="n">FW</span> <span class="n">update</span> <span class="n">Req</span>
<span class="nl">cmd</span><span class="p">:</span> <span class="n">u</span>
</pre></div>
</div>
<p>The available commands are:</p>
<blockquote>
<div><ul class="simple">
<li>sxx: Select a device. Example ‘s1’| ‘s0x1234’</li>
<li>o:   Toggle the permit join</li>
<li>l:   List devices</li>
<li>t:   Send an LED toggle request to selected device</li>
<li>v:   Send a version request to selected device</li>
<li>u:   Send FW update request to selected device</li>
<li>d:   Send disassociation request to selected device</li>
<li>fxx: Set FW file from configured OAD FW dir. Example ‘f sensor_mac_oad_cc13x2lp_app.bin’</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="oad-pause-and-resume">
<span id="sec-oad-pause-and-resume"></span><h2>OAD Pause and Resume<a class="headerlink" href="#oad-pause-and-resume" title="Permalink to this headline">¶</a></h2>
<p>The TI 15.4-Stack OAD feature supports the following robustness features:</p>
<ol class="arabic simple">
<li>Timeouts: This is when a the data request for a block response is not
answered. The data request delay from an OAD block request being sent is set
by OAD_BLOCK_REQ_POLL_DELAY ms, it is advised that this be set as short as
possible to avoid unnecessary queueing of data in the co-processor. A
timeout is typically caused by the Linux collector taking too long to read
the OAD Block from the FW Image file (due to CPU load). The number of
timeouts before a retry is set by OAD_MAX_TIMEOUTS.</li>
<li>Retries: A retry is when the maximum number timeouts has expired before the
OAD Block Response has been received. In his case the OAD Block Request is
resent. The number of retires before an OAD abort is set by OAD_MAX_RETRIES.</li>
<li>Aborts: The OAD is aborted after there are OAD_MAX_RETRIES block requests with
no response. After an OAD abort the OAD is attempted to be resumed after
OAD_BLOCK_AUTO_RESUME_DELAY ms, if the OAD abort again on the same block number
the OAD is terminated.</li>
</ol>
<p>The OAD is aborted if the device orphans, but when the device rejoins an OAD resume
is attempted. If the device is reset / powered off during an OAD the device will
attempt to resume when it rejoins. The block it resumes from is set to the first
block of the page it was aborted from in case the flash page was corrupted by
the power cycle.</p>
</div>
<div class="section" id="support-for-multiple-oad-files">
<h2>Support for multiple OAD files<a class="headerlink" href="#support-for-multiple-oad-files" title="Permalink to this headline">¶</a></h2>
<p>The OAD protocol supports multiple OAD images by using an Image ID that is sent
when the collector initiates the OAD and then in each OAD block request /
response. This ensures that the device always receives a block from the correct
FW image, especially in the case where a device loses power or orphans and it is
not known when it will come back online. When an OAD image file is selected on
the collector it is assigned a new image ID and added to a table, when a block
request is received the image ID in the block request is used to find the
correct FW image file. This guarantees that a device will always get a block from
the correct image, no matter how long it is offline.</p>
</div>
<div class="section" id="oad-default-settings">
<h2>OAD Default Settings<a class="headerlink" href="#oad-default-settings" title="Permalink to this headline">¶</a></h2>
<p>Most OAD settings are defined in <code class="docutils literal notranslate"><span class="pre">oad_client.c</span></code> and <code class="docutils literal notranslate"><span class="pre">oad_config.h</span></code>, and already
discussed in <a class="reference internal" href="#sec-oad-pause-and-resume"><span class="std std-ref">OAD Pause and Resume</span></a>. In addition to this you can override the
<code class="docutils literal notranslate"><span class="pre">OAD_BLOCK_SIZE</span></code> from the default of 128 by defining it in the project options.
Setting this higher than 128 is not advised as this is the setting used during
system testing.</p>
<p>Beacon Mode, Non Beacon Mode and Frequency Hopping network modes are supported.
In Non Beacon Mode and Frequency Hopping the default OAD parameters are:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define OAD_BLOCK_REQ_RATE            200</span>
<span class="cp">#define OAD_BLOCK_REQ_POLL_DELAY      50</span>
<span class="cp">#define OAD_MAX_TIMEOUTS              3</span>
<span class="cp">#define OAD_MAX_RETRIES               3</span>
<span class="cp">#define OAD_BLOCK_AUTO_RESUME_DELAY   5000</span>
</pre></div>
</div>
<p>Under normal conditions the sensor sends a block request every 200ms, with a
typical file of 920 blocks this takes ~3 minutes. In Beacon Mode only one data
request can be sent during 1 beacon interval. The default OAD settings are:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define BEACON_INTERVAL             ((((0x01) &lt;&lt; (CONFIG_MAC_BEACON_ORDER)) * \</span>
<span class="cp">                                      (SYMBOL_DURATION) * (BASE_SUPER_FRAME_DURATION)) / (1000)) </span><span class="c1">// ms</span>
<span class="cp">#define OAD_BLOCK_REQ_RATE            ((BEACON_INTERVAL) - 100)</span>
<span class="cp">#define OAD_BLOCK_REQ_POLL_DELAY      ((BEACON_INTERVAL) - 400)</span>
<span class="cp">#define OAD_MAX_TIMEOUTS              3</span>
<span class="cp">#define OAD_MAX_RETRIES               3</span>
<span class="cp">#define OAD_BLOCK_AUTO_RESUME_DELAY   (CONFIG_MAC_SUPERFRAME_ORDER * 5)</span>
</pre></div>
</div>
<p>Under normal conditions the OAD will take CONFIG_SUPERFRAME_ORDER * 920 seconds.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sensor_oad</span></code> project has 2 defines related to the OAD feature, defined by
default in the Application/Defines/sensor_oad .opts file:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">FEATURE_BLE_OAD</span></code> This includes the OAD linker command file and OAD TI-RTOS
config file that supports updates through BLE.</li>
<li><code class="docutils literal notranslate"><span class="pre">FEATURE_NATIVE_OAD</span></code> This includes the TI 15.4-Stack OAD client. This
results in an application that supports the OAD messages needed to receive
an OAD update over the TI 15.4-Stack network.</li>
</ul>
<p>Removing the <code class="docutils literal notranslate"><span class="pre">FEATURE_NATIVE_OAD</span></code> symbol will result in an application that is
capable of being updated through a BLE link only. For a TI 15.4-Stack OAD both
<code class="docutils literal notranslate"><span class="pre">FEATURE_BLE_OAD</span></code> and <code class="docutils literal notranslate"><span class="pre">FEATURE_NATIVE_OAD</span></code> should be defined.</p>
</div>
<div class="section" id="turbo-oad-protocol">
<span id="sec-turbo-oad"></span><h2>Turbo OAD Protocol<a class="headerlink" href="#turbo-oad-protocol" title="Permalink to this headline">¶</a></h2>
<p>The Turbo OAD Protocol was designed to speed up the traditional OAD protocol,
specifically in terms of power consumption and over the air time.</p>
<p>Turbo OAD enables the support of using delta software updates in
the OAD protocol. Delta updates are software updates that contain only the
changed or updated content in the new software image.</p>
<p>This section describes the Turbo OAD process and how it is used in conjunction
with the traditional OAD protocol described above. For information on how to
enable Turbo OAD, please refer to the TI 15.4 stack OAD examples’ readme files.</p>
<div class="figure align-center" id="fig-toad-high-level">
<img alt="../_images/fig-toad-high-level.png" src="../_images/fig-toad-high-level.png" />
<p class="caption"><span class="caption-number">Figure 94. </span><span class="caption-text">High Level Overview of Turbo OAD integration</span></p>
</div>
<p>As shown in <a class="reference internal" href="#fig-toad-high-level"><span class="std std-numref">Figure 94.</span></a>, the core logic of Turbo OAD to create
delta images is done with the Turbo OAD Image Tool, while reconstructing the
delta image is done on the OAD Target device.</p>
<div class="section" id="turbo-oad-image-tool">
<h3>Turbo OAD Image Tool<a class="headerlink" href="#turbo-oad-image-tool" title="Permalink to this headline">¶</a></h3>
<p>The Turbo OAD Image tool is invoked as a post-build step by the OAD project.
The purpose of the tool is to perform the delta and run-length encoding
processes. The Turbo OAD Image tool takes in two binary images and outputs one delta image,
which is then sent to the target OAD device through the OAD protocol described
above.</p>
<p>The tool will also determine if a Turbo OAD is needed based on the
delta image. If there is no power / image size savings by using Turbo OAD, then
regular OAD will be used. The tool will output an error message indicating that
the delta image was not created.</p>
</div>
<div class="section" id="turbo-oad-block-transfer-overview">
<h3>Turbo OAD Block Transfer Overview<a class="headerlink" href="#turbo-oad-block-transfer-overview" title="Permalink to this headline">¶</a></h3>
<p>The OAD protocol for transferring the image mainly remains the same. However,
instead of directly writing received OAD blocks to external/internal flash, OAD
blocks are cached in RAM and are decoded (during the OAD image transfer) before
writing to flash. This has the following implications:</p>
<blockquote>
<div><ul class="simple">
<li>No additional flash space is required to store the delta image.</li>
<li>RAM is required to store received OAD blocks and a write buffer to store
decoded image data before flashing. In general, the more RAM used, the
faster the OAD and decoding process will be.</li>
<li>Since the RAM used is dynamically allocated, the OAD update could fail on
initialization if there are insufficient resources to decode the delta image.</li>
<li>OAD block requests may need to be temporarily ‘paused’ if the block buffer
cache is full and the device is still decoding data. OAD block requests will
resume once there is space in the storage buffer to continue the transfer.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="turbo-oad-image-reconstruction-process-overview">
<h3>Turbo OAD Image Reconstruction Process Overview<a class="headerlink" href="#turbo-oad-image-reconstruction-process-overview" title="Permalink to this headline">¶</a></h3>
<p>The 15.4 OAD protocol initiates the OAD transfer by having the collector select
the delta image to transfer and sending the ImgIdentifyReq to the sensor. The
Turbo OAD segment header fields have been added to the ImgIdentifyReq to
facilitate the transfer of delta images. For more information regarding the
Turbo OAD header segment, see the Turbo OAD Delta Image Header section.</p>
<div class="figure align-center" id="fig-toad-image-validation">
<img alt="../_images/fig-toad-image-validation.png" src="../_images/fig-toad-image-validation.png" />
<p class="caption"><span class="caption-number">Figure 95. </span><span class="caption-text">Turbo OAD Image Validation and Reconstruction Overview</span></p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Performing a Turbo OAD to a target device that has been flashed with
traditional OAD firmware is not supported.</p>
</div>
<p>The image reconstruction process is done during the OAD transfer. The decoding
process consists of a temporary block cache (ring buffer) that stores received
blocks which have not been decoded. Decoded blocks are written to an image
buffer that is then flashed to the device when filled.</p>
<p>The process begins with receiving an OAD block from the collector. After a
control block instruction has been received, the decoding process will begin.
When the data from the OAD block has been decoded, the block will be marked to
indicate that the space can be used to store a subsequent OAD block.</p>
<p>Note that each OAD block is a pre-determined size as specified by the
<code class="docutils literal notranslate"><span class="pre">OAD_BLOCK_SIZE</span></code> define. A Delta Image block can be any arbitrary size, and
typically will be larger than <code class="docutils literal notranslate"><span class="pre">OAD_BLOCK_SIZE</span></code>. The implication of this is
that multiple OAD blocks must be received by the sensor until a decoding
instruction can fully be processed. However, the complete instruction does not
need to be received in order to begin the decoding process.</p>
<p>OAD blocks are still requested at the rate defined by <code class="docutils literal notranslate"><span class="pre">OAD_BLOCK_REQ_RATE</span></code>.
However, if the OAD block cache is full, the OAD transfer will be paused until
there is room to store the next block.</p>
<div class="figure align-center" id="fig-toad-state-machine">
<img alt="../_images/fig-toad-state-machine.png" src="../_images/fig-toad-state-machine.png" />
<p class="caption"><span class="caption-number">Figure 96. </span><span class="caption-text">Turbo OAD Decoding State Machine</span></p>
</div>
<table border="1" class="docutils" id="tab-toad-decode-defines">
<caption><span class="caption-number">Table 23. </span><span class="caption-text">Turbo OAD Decoding State Machine Descriptions</span><a class="headerlink" href="#tab-toad-decode-defines" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="8%" />
<col width="92%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">State</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Uninitialized</td>
<td>Starting state before the Turbo OAD module has been initialized</td>
</tr>
<tr class="row-odd"><td>Idle</td>
<td>The module is waiting for new data to be received in the block cache</td>
</tr>
<tr class="row-even"><td>Decoding</td>
<td>The module is currently decoding a delta block</td>
</tr>
<tr class="row-odd"><td>Waiting</td>
<td>The module is either currently decoding a delta block or is ready to begin decoding the next block. However, not enough data is available in the block cache to continue decoding</td>
</tr>
<tr class="row-even"><td>Done</td>
<td>Completion of decoding the delta image</td>
</tr>
</tbody>
</table>
<p>Since the length of the uncompressed delta block is variable, the decoding
process will yield to the application task if the image buffer has been flushed,
or a full instruction has been decoded. If an instruction has not been fully
decoded, the decoding process will resume after any pending application code has
been executed.</p>
</div>
<div class="section" id="turbo-oad-delta-image-header">
<h3>Turbo OAD Delta Image Header<a class="headerlink" href="#turbo-oad-delta-image-header" title="Permalink to this headline">¶</a></h3>
<p>Upon completion of the OAD transfer and delta image decoding, the Turbo OAD
process is complete, and the normal process of verifying the image CRC and
rebooting remains the same.</p>
<p>The modified OAD Image Header can be seen in <code class="docutils literal notranslate"><span class="pre">oad_image_header_app.c</span></code> as shown here:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="p">.</span><span class="n">imgID</span> <span class="o">=</span> <span class="n">OAD_IMG_ID_VAL</span><span class="p">,</span>
    <span class="p">.</span><span class="n">crc32</span> <span class="o">=</span> <span class="n">DEFAULT_CRC</span><span class="p">,</span>
    <span class="p">.</span><span class="n">bimVer</span> <span class="o">=</span> <span class="n">BIM_VER</span><span class="p">,</span>
    <span class="p">.</span><span class="n">metaVer</span> <span class="o">=</span> <span class="n">META_VER</span><span class="p">,</span>                   <span class="c1">//!&lt; Metadata version */</span>

    <span class="p">.</span><span class="n">techType</span>      <span class="o">=</span> <span class="n">OAD_WIRELESS_TECH_TIMAC</span><span class="p">,</span>    <span class="c1">//!&lt; Wireless protocol type BLE/TI-MAC/ZIGBEE etc. */</span>

    <span class="p">.</span><span class="n">imgCpStat</span> <span class="o">=</span> <span class="n">DEFAULT_STATE</span><span class="p">,</span>            <span class="c1">//!&lt; Image copy status bytes */</span>
    <span class="p">.</span><span class="n">crcStat</span> <span class="o">=</span> <span class="n">DEFAULT_STATE</span><span class="p">,</span>              <span class="c1">//!&lt; CRC status */</span>
    <span class="p">.</span><span class="n">imgNo</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>                          <span class="c1">//!&lt; Image number of &#39;image type&#39; */</span>
    <span class="p">.</span><span class="n">imgVld</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span>                  <span class="c1">//!&lt; In indicates if the current image in valid 0xff - valid, 0x00 invalid image */</span>
    <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">INVALID_LEN</span><span class="p">,</span>                     <span class="c1">//!&lt; Image length in bytes. */</span>
    <span class="p">.</span><span class="n">softVer</span> <span class="o">=</span> <span class="n">SOFTWARE_VER</span><span class="p">,</span>               <span class="c1">//!&lt; Software version of the image */</span>
    <span class="p">.</span><span class="n">hdrLen</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">imgHdr_t</span><span class="p">,</span> <span class="n">fixedHdr</span><span class="p">.</span><span class="n">rfu</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(((</span><span class="n">imgHdr_t</span><span class="p">){</span><span class="mi">0</span><span class="p">}).</span><span class="n">fixedHdr</span><span class="p">.</span><span class="n">rfu</span><span class="p">),</span>
                                            <span class="c1">//!&lt; Total length of the image header */</span>
    <span class="p">.</span><span class="n">rfu</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>                         <span class="c1">//!&lt; reserved bytes */</span>
<span class="cp">#ifdef __TI_COMPILER_VERSION__</span>
    <span class="p">.</span><span class="n">prgEntry</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">prgEntryAddr</span><span class="p">,</span>
    <span class="p">.</span><span class="n">imgEndAddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">flashEndAddr</span><span class="p">,</span>
<span class="cp">#elif  defined(__IAR_SYSTEMS_ICC__)</span>
    <span class="p">.</span><span class="n">prgEntry</span>   <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">__section_begin</span><span class="p">(</span><span class="s">&quot;.intvec&quot;</span><span class="p">)),</span> <span class="c1">//!&lt; Program entry address */</span>
    <span class="p">.</span><span class="n">imgEndAddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">__section_end</span><span class="p">(</span><span class="s">&quot;ROSTK&quot;</span><span class="p">)),</span>
<span class="cp">#endif</span>
  <span class="cp">#if defined HAL_IMAGE_A</span>
    <span class="p">.</span><span class="n">imgType</span> <span class="o">=</span>  <span class="n">OAD_IMG_TYPE_PERSISTENT_APP</span><span class="p">,</span>
  <span class="cp">#else</span>
    <span class="p">.</span><span class="n">imgType</span> <span class="o">=</span> <span class="n">OAD_IMG_TYPE_APPSTACKLIB</span><span class="p">,</span>
  <span class="cp">#endif</span>
  <span class="p">}</span>
</pre></div>
</div>
<table border="1" class="docutils" id="tab-toad-image-header-seg-val">
<caption><span class="caption-number">Table 24. </span><span class="caption-text">Turbo OAD Image Segment Values</span><a class="headerlink" href="#tab-toad-image-header-seg-val" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Segment Type</td>
<td>0x05 (Delta Image)</td>
</tr>
<tr class="row-odd"><td>Wireless Technology</td>
<td>0xFFFD (Sub-1 Ghz) or 0xFFFB (2.4 Ghz)</td>
</tr>
<tr class="row-even"><td>Reserved</td>
<td>0xFF</td>
</tr>
<tr class="row-odd"><td>Payload Length</td>
<td>0x14</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils" id="tab-toad-image-header-seg-format">
<caption><span class="caption-number">Table 25. </span><span class="caption-text">Turbo OAD Segment Header</span><a class="headerlink" href="#tab-toad-image-header-seg-format" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="12%" />
<col width="16%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Size (in bytes)</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>isDeltaImg</td>
<td>1</td>
<td>Indicates if the image is a delta image</td>
</tr>
<tr class="row-odd"><td>memoryCfg</td>
<td>1</td>
<td>OAD flash configuration (off-chip or on-chip)</td>
</tr>
<tr class="row-even"><td>newImgCrc</td>
<td>4</td>
<td>Crc value of the new/updated application image to be flashed on the device</td>
</tr>
<tr class="row-odd"><td>oldImgCrc</td>
<td>4</td>
<td>Crc value of the old/current application image running on the device</td>
</tr>
<tr class="row-even"><td>toadMetaVer</td>
<td>1</td>
<td>Version of the delta image header segment</td>
</tr>
<tr class="row-odd"><td>toadVer</td>
<td>1</td>
<td>Version of the Turbo OAD decoding algorithm</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils" id="tab-toad-image-header-oad-data">
<caption><span class="caption-number">Table 26. </span><span class="caption-text">Modified OAD Header data</span><a class="headerlink" href="#tab-toad-image-header-oad-data" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="11%" />
<col width="15%" />
<col width="74%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Value</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Image Length</td>
<td>Delta Image Length</td>
<td>Uncompressed image’s length is stored in the Turbo OAD segment header after image is reconstructed</td>
</tr>
</tbody>
</table>
<p>The Turbo OAD Version and Original Image CRC field is used during the
ImgIdentifyReq to ensure that the delta image can properly be reconstructed. The
length of the new image is stored in the Turbo OAD header because the OAD
header’s length field is the size of the delta image and not the reconstructed
image size. When the OAD header is received from delta image, the length field
will be replaced with the value stored in the ‘Image Length’ field.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Turbo OAD is currently not supported for on-chip OAD.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../oad-secure/tools.html" class="btn btn-neutral float-right" title="OAD Image Tool" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../oad-secure/flash-layout-on-chip-stack-library.html" class="btn btn-neutral float-left" title="Flash Layout for On-Chip OAD" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        <a href="https://www.ti.com/corp/docs/legal/copyright.shtml">2016-2020, Texas Instruments</a>, Texas Instruments Incorporated. All rights reserved. <br>
        <a href="https://www.ti.com/corp/docs/legal/trademark/trademrk.htm">Trademarks</a> | <a href="https://www.ti.com/corp/docs/legal/privacy.shtml">Privacy policy</a> | <a href="https://www.ti.com/corp/docs/legal/termsofuse.shtml">Terms of use</a> | <a href="https://www.ti.com/lsds/ti/legal/termsofsale.page">Terms of sale</a>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>